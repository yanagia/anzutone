var Anzu={};Anzu.ui={};
Anzu.core=function(){function j(){var b={Cd:65.4,"Cd#":69.3,Dd:73.425,"Dd#":77.775,Ed:82.4,Fd:87.3,"Fd#":92.5,Gd:98,"Gd#":103.825,Ad:55,"Ad#":58.275,Bd:61.7375},c;for(c=2;c<=9;c++)for(var g in b)f[g.replace("d",c.toString(10))]=f[g.replace("d",(c-1).toString(10))]*2}var f={A1:55,"A1#":58.275,B1:61.7375,C1:65.4,"C1#":69.3,D1:73.425,"D1#":77.775,E1:82.4,F1:87.3,"F1#":92.5,G1:98,"G1#":103.825};j();return{convertToPitch:function(b){return f[b]},audioStream:$("body"),samplingRate:22050,version:"0.0.1"}}();
function IsGecko(){if(navigator)if(navigator.userAgent)if(navigator.userAgent.indexOf("Gecko/")!=-1)return true;return false};Anzu.wave=function(){function j(b){return String.fromCharCode(b>>0&255,b>>8&255)}function f(b){return String.fromCharCode(b>>0&255,b>>8&255,b>>16&255,b>>24&255)}return{generator:{createSquareSignal:function(b,c){var g,e,d;d=0;b=Math.round(b*22050);var a=c*2*Math.PI/22050;g=new Array(b);for(c=0;c<b;c++){e=Math.sin(d);e=e>0?0.7:-0.7;g[c]=~~(e*32767);d+=a}return g},createSinSignal:function(b,c){var g,e,d;d=0;b=Math.round(b*22050);var a=c*2*Math.PI/22050;g=new Array(b);for(c=0;c<b;c++){e=Math.sin(d);
g[c]=~~(e*32767);d+=a}return g},createSawtoothSignal:function(b,c){var g,e,d;d=0;b=Math.round(b*22050);var a=22050/c;g=new Array(b);for(c=0;c<b;c++){if(d>a)d-=a;e=d*2/a-1;g[c]=~~(e*32767);d+=1}return g},createTriangleSignal:function(b,c){var g,e,d;d=0;b=Math.round(b*22050);var a=22050/c;g=new Array(b);for(c=0;c<b;c++){if(d>a)d-=a;e=d*2/a-1;e=(Math.abs(e)-0.5)*2;g[c]=~~(e*32767);d+=1}return g},createWhiteNoiseSignal:function(b){var c,g,e;b=Math.round(b*22050);g=new Array(b);for(c=0;c<b;c++){e=Math.random()*
2-1;g[c]=~~(e*32767)}return g}},mixSignal:function(b,c,g){var e,d,a;d=c.length;g=Math.floor(g);for(e=0;e<d;e++){a=b[e+g]+c[e];b[e+g]=a}},mixSignalV:function(b,c,g,e){var d,a,i;a=c.length;g=Math.floor(g);for(d=0;d<a;d++){i=b[d+g]+~~(c[d]*e);b[d+g]=i}},convertToBinary:function(b){var c,g,e;g=b.length;for(c=0;c<g;c++){e=b[c];e=e>393204?393204:e<-393204?-393204:e;b[c]=String.fromCharCode((e+393204)/786408*256)}return b.join("")},convertToURL:function(b){var c;c="WAVEfmt ";c+=f(16);c+=j(1);c+=j(1);c+=
f(22050);c+=f(22050);c+=j(1);c+=j(8);c+="data";var g;g=f(b.length);c+=g;g="RIFF";g+=f(c.length+b.length);return"data:audio/wav;base64,"+Base64.encode(g+c+b)}}}();Anzu.Score=function(){return function(j){if(typeof j==="string")try{j=JSON.parse(j)}catch(f){alert("Parse Error");console.log(f)}for(var b=[],c,g,e,d=0;d<j.tracks.length;d++)b[d]=Anzu.Track(j.tracks[d]);return{bpm:j.bpm,addTrack:function(a){b.push(a)},updateTrack:function(a,i){b[a]=i},setCallback:function(a){g=a},setAfterCallback:function(a){e=a},play:function(a){var i,l,m,n,o,q,p,v,w;w=Anzu.core.samplingRate;l=b.length;p=this.getEndTime();q=60/this.bpm;v=Math.ceil((p-a)*q*w);if(v<=0)v=1;n=new Array(v);
for(i=0;i<v;i++)n[i]=0;Anzu.mixer.init(n);Anzu.mixer.setCallback(function(){var u=Anzu.wave.convertToBinary(n);u=Anzu.wave.convertToURL(u);c=new Audio(u);Anzu.core.audioStream.append($(c));c.volume=1;u=u=o=n=null;if(g)var t=setInterval(function(){if(c.currentTime>0.1){clearInterval(t);g(q,p-a,c.currentTime/q)}},100);e&&setTimeout(function(){e();if(c){c.pause();c.src=undefined;$(c).remove()}},v/w*1E3+100);c.play()});for(i=0;i<l;i++){m=b[i];o=m.getSignalOpt(n,a,q)}Anzu.mixer.finishAddQueues()},stop:function(){c.pause();
$(c).remove()},getEndTime:function(){var a,i,l,m;i=b.length;for(a=m=0;a<i;a++){l=b[a];l=l.getLastNote();l=l.begin+l.length;if(l>m)m=l}return m},getTrack:function(a){return b[a]},dump:function(){return'{"tracks":['+b.map(function(a){return a.dump()}).join(",")+'],"bpm":'+this.bpm+',"maxID":'+this.getMaxID()+"}"},changeBPM:function(a){this.bpm=a},changeNote:function(a,i){var l,m,n;if(l=Anzu.cache.getNote(a)){if(l===i)return;m=i.split("~");if(m[1]===""){n=parseInt(m[0]);b[n].deleteNote(eval("("+l.split("~")[1]+
")"))}else{n=parseInt(m[0]);b[n].updateNote(a,m[1])}}else{m=i.split("~");if(m[1]==="")return;n=parseInt(m[0]);b[n].updateNote(a,m[1])}Anzu.cache.setNote(a,i)},getMaxID:function(){for(var a,i,l=a=0;l<b.length;l++){i=b[l].getMaxID();if(i>a)a=i}return a},getOnionTracks:function(){for(var a=[],i=0;i<b.length;i++)b[i].isOnion()&&a.push(b[i]);return a}}}}();
Anzu.Track=function(){return function(j){if(typeof j==="string")j=JSON.parse(j);var f,b,c=0.5,g=false;f=j.notes;for(var e=0;e<f.length;e++)f[e]=Anzu.Note(f[e]);if(j.tone.match(/\.js/)){b="Anzu.SequareWave";Anzu.tone.addUserTone(j.tone,function(d){b=d})}else b=j.tone;c=j.volume?Math.abs(j.volume)>1?0.5:j.volume:0.5;return{addNote:function(d){f.push(d)},deleteNote:function(d){for(var a=0;a<f.length;a++)if(f[a].divID==d.divID){f.splice(a,1);return}},deleteUnlinkNotes:function(){for(var d=f.length-1;d>=
0;d--)f[d].divID||f.splice(d,1)},getNote:function(d){for(var a=0;a<f.length;a++)if(f[a].divID==d)return f[a];return null},_notes:function(){return f},deleteNoteFromDiv:function(d){for(var a=0;a<f.length;a++)if(f[a].divID==parseInt(d.id,10)){Anzu.eventManager.add("deleteNote",f[a]);f.splice(a,1);return}},changeNote:function(d){for(var a=0;a<f.length;a++)if(f[a].divID==parseInt(d.id,10)){f[a].setDiv(d);Anzu.eventManager.add("changeNote",f[a]);return}},setTone:function(d){b=d},getTone:function(){return b},
getLastNote:function(){if(f.length===0)return Anzu.Note({begin:0,length:0,key:"A4"});f.sort(function(d,a){return d.begin+d.length-(a.begin+a.length)});return f[f.length-1]},getSignal:function(d,a){var i=Anzu.core.samplingRate,l,m,n,o,q,p;p=Anzu.tone.getTone(b);m=f.length;l=this.getLastNote();n=Math.ceil((l.begin+l.length)*a*i);l=new Array(n);for(o=0;o<n;o++)l[o]=0;for(o=0;o<m;o++){n=f[o];if(!(n.begin<d)){q=n.getSignal(p,a);Anzu.wave.mixSignal(l,q,(n.begin-d)*a*i)}}return l},getSignalOpt:function(d,
a,i){var l=Anzu.core.samplingRate,m,n,o,q,p;p=Anzu.tone.getTone(b);n=f.length;m=this.getLastNote();Math.ceil((m.begin+m.length)*i*l);if(typeof p==="function")for(m=0;m<n;m++){o=f[m];if(!(o.begin<a)){q=o.getSignal(p,i);Anzu.wave.mixSignalV(d,q,(o.begin-a)*i*l,c)}}else for(m=0;m<n;m++){o=f[m];if(!(o.begin<a)){q=m+"@"+o.begin+"@"+o.length;Anzu.mixer.addQueue({key:q,info:{start:(o.begin-a)*i*l,volume:c}});o.getSignalASync(p,i,q)}}return d},isOnion:function(){return g},setOnion:function(d){g=d},getVolume:function(){return c},
setVolume:function(d){c=d},getMaxID:function(){for(var d,a,i=d=0;i<f.length;i++){a=f[i].divID;if(a>d)d=a}return d},updateNote:function(d,a){for(var i=0;i<f.length;i++)if(f[i].divID==d){f[i]=Anzu.Note(eval("("+a+")"));return}f.push(Anzu.Note(eval("("+a+")")))},dump:function(){return'{"notes":['+f.map(function(d){return d.dump()}).join(",")+'],"tone":"'+Anzu.tone.getToneDumpName(b)+'","volume":'+c+"}"}}}}();
Anzu.Note=function(){return function(j){j=!j?{}:j;return{begin:j.begin,length:j.length,key:j.key,divID:j.divID,dirty:true,setDiv:function(f){this.div=f;var b,c,g;b=parseInt(f.style.top,10);c=parseInt(f.style.left,10);g=parseInt(f.style.width,10);this.begin=c/100;this.length=g/100;this.key=Anzu.ui.posKeyList[Math.floor((b+5)/20)*20];if(!this.divID)this.divID=parseInt(f.id,10)},getSignal:function(f,b){return f(b*this.length,Anzu.core.convertToPitch(this.key))},getSignalASync:function(f,b,c){f.call(b*
this.length,Anzu.core.convertToPitch(this.key),c)},dump:function(){return'{"begin":'+this.begin+',"length":'+this.length+',"key":"'+this.key+'","divID":"'+this.divID+'"}'}}}}();Anzu.mixer=function(){function j(){if(!g)return false;var e=0;for(var d in f)e++;return e===0}var f={},b,c,g=false;return{init:function(e){b=e;f={};g=false},addQueue:function(e){f[e.key]=e.info},finishAddQueues:function(){g=true;j()&&c()},finishQueue:function(e){var d=e.key;Anzu.wave.mixSignalV(b,e.signals,f[d].start,f[d].volume);delete f[d];j()&&c()},setCallback:function(e){c=e}}}();Anzu.tone=function(){function j(e){var d={};if(typeof e==="string"){e=e.split(",");var a,i=e.length;for(a=0;a<i-1;a++)e[a]=parseInt(e[a],10);a=e.pop();d.key=a;d.signals=e}else d=e;return d}var f={},b={},c=Anzu.wave.createSquareSignal,g={};f["Anzu.SquareWave"]=Anzu.wave.generator.createSquareSignal;f["Anzu.SineWave"]=Anzu.wave.generator.createSinSignal;f["Anzu.SawtoothWave"]=Anzu.wave.generator.createSawtoothSignal;f["Anzu.WhiteNoise"]=Anzu.wave.generator.createWhiteNoiseSignal;return{addTone:function(e,
d){f[e]=d},getToneList:function(){var e=[],d;for(d in f)e.push(d);for(d in b)e.push(d);return e},getToneDumpName:function(e){if(f[e])return e;else if(b[e])return g[e];return"Anzu.SequareWave"},getTone:function(e){var d=f[e];if(d)return d;else{var a=b[e];return a?{call:function(i,l,m){(function(n){parseInt(n);var o;a.onmessage=function(){return function(q){q=j(q.data);Anzu.mixer.finishQueue({key:q.key,signals:q.signals})}}(n);o=IsGecko()?0:1;a.postMessage(i+"|"+l+"|"+Anzu.core.samplingRate+"|"+n+"|"+
o)})(m)}}:Anzu.wave.createSquareSignal}},getDefaultTone:function(){return c},setDefaultTone:function(e){if(f[e])c=this.getTone(e);else if(b[e]){var d=b[e];c={call:function(a,i,l){d.onmessage=function(n){n=j(n.data).signals;a(n)};var m=IsGecko()?0:1;d.postMessage(i+"|"+l+"|"+Anzu.core.samplingRate+"|once|"+m)}}}return f["Anzu.SeguareWave"]},addUserTone:function(e,d,a){for(var i in g)g.key===e&&d(i);var l=new Worker("usertone.js");l.onmessage=function(m){m=m.data.split("@")[0];b[m]=l;g[m]=e;d&&d(m);
Anzu.player.refreshTone()};l.onerror=function(m){a(m.message)};l.postMessage("init|"+e)}}}();Anzu.cache=function(){var j={};return{setNote:function(f,b){j[f]=b},getNote:function(f){return j[f]}}}();Anzu.eventManager=function(){var j=0,f=0;return{add:function(b,c){if(typeof wave!=="undefined"){var g=c.divID,e={};switch(b){case "addNote":case "changeNote":b=j+"~"+c.dump();e[g]=b;wave.getState().submitDelta(e);Anzu.cache.setNote(g,b);break;case "deleteNote":b=j+"~";e[g]=b;wave.getState().submitDelta(e);Anzu.cache.setNote(g,b);break;case "changeBPM":b=c.toString(10);e.BPM=b;wave.getState().submitDelta(e);break;case "changeTone":b=c;e[j.toString(10)+" tone"]=b;wave.getState().submitDelta(e);break;
case "changeVolume":b=c.toString(10);e[j.toString(10)+" volume"]=b;wave.getState().submitDelta(e);break}}},changeState:function(){for(var b=wave.getState(),c=b.getKeys(),g,e,d=0;d<c.length;d++){g=c[d];switch(g){case "divID":f=parseInt(wave.getState().get("divID"));break;case "BPM":Anzu.player._setBPM(wave.getState().get("BPM"));break;default:if(g.match(/tone/)){e=parseInt(g,10);Anzu.player._setTone(e,wave.getState().get(g));break}if(g.match(/volume/)){e=parseInt(g,10);Anzu.player._setVolume(e,wave.getState().get(g));
break}Anzu.player.score.changeNote(g,b.get(g));break}}Anzu.player.renderScoreAgain()},changeCurrentTrack:function(b){j=b},setDivID:function(b){f=b},getDivID:function(){return f},incDivID:function(){if(typeof wave!=="undefined"){f=parseInt(wave.getState().get("divID","0"),10)+1;wave.getState().submitDelta({divID:f})}else f+=1},init:function(b){if(typeof wave!=="undefined"&&wave.getState().get("divID")){f=0;f=wave.getState().get("divID")}else f=b?b:0}}}();$(function(){Anzu.player.score=Anzu.Score('{"tracks" : [ { "notes" : [], "tone" : "Anzu.SquareWave"}, { "notes" : [], "tone" : "Anzu.SquareWave"}, { "notes" : [], "tone" : "Anzu.SquareWave"},{ "notes" : [], "tone" : "Anzu.SquareWave"},{ "notes" : [], "tone" : "Anzu.SquareWave"},{ "notes" : [], "tone" : "Anzu.SquareWave"},{ "notes" : [], "tone" : "Anzu.SquareWave"},{ "notes" : [], "tone" : "Anzu.SquareWave"},{ "notes" : [], "tone" : "Anzu.SquareWave"},{ "notes" : [], "tone" : "Anzu.SquareWave"},{ "notes" : [], "tone" : "Anzu.SquareWave"},{ "notes" : [], "tone" : "Anzu.SquareWave"} ], "bpm" : 120}');
$("#back1Button").button({icons:{primary:"ui-icon-seek-first"},text:false}).click(function(){Anzu.player.moveBar(-400)});$("#back4Button").button({icons:{primary:"ui-icon-seek-prev"},text:false}).click(function(){Anzu.player.moveBar(-100)});$("#playstopButton").button({icons:{primary:"ui-icon-play"},text:false}).click(function(){Anzu.player.playstop()});$("#play1Button").button({icons:{primary:"ui-icon-seek-next"},text:false}).click(function(){Anzu.player.moveBar(+100)});$("#play4Button").button({icons:{primary:"ui-icon-seek-end"},
text:false}).click(function(){Anzu.player.moveBar(+400)});$("#bpmButton").button({}).click(function(){$("#bpmDialog").dialog("open")});$("#saveButton").button({}).click(function(){Anzu.player.openExportDialog()});$("#onionCheckBox").button({icons:{primary:"ui-icon-check"}}).click(function(){Anzu.player.setOnion(this.checked)});$("#bpmDialog").dialog({autoOpen:false,modal:true,buttons:{"Set new BPM":function(){var b=$("#bpmForm").val();Anzu.player.changeBPM(b);$("#bpmButton > .ui-button-text").html("BPM="+
b);$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},close:function(){}});$("#addToneDialog").dialog({autoOpen:false,modal:true,buttons:{"Load this tone":function(){var b=$("#userToneForm").val();if(b.match(/\.js/)){$("#userToneFormHelper").text("Now loading ...");Anzu.player.addUserTone(b,function(){$("#addToneDialog").dialog("close")})}else $("#userToneFormHelper").addClass("ui-state-highlight").text("Invalid URL. Tone file must be JavaScript file. (*.js only)")},Cancel:function(){$(this).dialog("close")}},
close:function(){}});$("#exportDialog").dialog({autoOpen:false,modal:true});$("#trackVolume").slider({value:50,range:"min",stop:function(){var b=$("#trackVolume").slider("value")/100;Anzu.player.changeVolume(b)},animate:true});$("#toneSelect").buttonset();var j=document.createElement("IFRAME");document.getElementById("trackviewContainer").appendChild(j);var f=frames[frames.length-1].document;j.width="100%";j.height="80%";j.className="trackview";j.id="pianorole";j.frameborder="0";f.open();f.write('<html>'+'<head>'+'<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />'+'<link type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/ui-lightness/jquery-ui.css" rel="stylesheet" />'+'<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>'+'<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js" type="text/javascript" ></script>'+'<script type="text/javascript" src="http://anzutone.appspot.com/js/base64.js"></script>'+'<link type="text/css" href="http://anzutone.appspot.com/wave/css/anzu/tooltip.css" rel="stylesheet" />'+'<link type="text/css" href="http://anzutone.appspot.com/wave/css/anzu/note.css" rel="stylesheet" />'+'<script type="text/javascript" src="http://anzutone.appspot.com/wave/js/anzu/pianorole-min.js"></script>'+'<script type="text/javascript" src="http://anzutone.appspot.com/wave/js/init.js"></script>'+'</head>'+'<body>'+'<div id="role">'+'</div>'+'<div id="bar" class="ui-state-highlight" style="width: 2px; position: absolute; height: 1920px; top: 0px; left: 100px; z-index: 999;"></div>'+'<div class="tooltip" id="barTooltip">'+'<div class="tooltipTri"></div><div class="tooltipBody"><div class="tooltipInner" id="barTooltipInner">abc</div></div>'+'</div>'+'<div id="audioStream"></div>'+'</body>'+'</html>');
f.close();j.onload=Anzu.player.frameLoaded;wave.setStateCallback(Anzu.eventManager.changeState);gadgets.window.adjustHeight(600)});
Anzu.player=function(){function j(){b=$("iframe")[0].contentWindow.Anzu.ui.getCurrentTime()}function f(){return $("iframe")[0].contentWindow.Anzu.ui.getTrack()}var b=0,c=0,g=false,e="",d="";return{play:function(){var a=$("iframe")[0].contentWindow;j();Anzu.player.score.updateTrack(c,$("iframe")[0].contentWindow.Anzu.ui.getTrack());Anzu.player.score.setCallback(a.Anzu.ui.startAnimation);Anzu.player.score.setAfterCallback(function(){g=false});Anzu.player.score.play(b)},stop:function(){Anzu.player.score.stop(b);
$("iframe")[0].contentWindow.Anzu.ui.stopAnimation()},playstop:function(){g?this.stop():this.play();g=!g},set:function(){if(typeof $("iframe")[0].contentWindow.Anzu!=="undefined"){$("iframe")[0].contentWindow.Anzu.ui.setScore(Anzu.player.score);var a=Anzu.player.score.getTrack(c);$("iframe")[0].contentWindow.Anzu.ui.setTrack(a);$('input[name="tone"]').each(function(i,l){l.checked=l.value===a.getTone()?true:false});$("#trackVolume").slider("value",a.getVolume()*100);$("#onionCheckBox")[0].checked=
a.isOnion();$("#onionCheckBox").button("refresh");$("#toneSelect").button("destroy");$("#toneSelect").buttonset()}},setEventManager:function(){$("iframe")[0].contentWindow.Anzu.eventManager=Anzu.eventManager;$("iframe")[0].contentWindow.Anzu.tone=Anzu.tone},moveBar:function(a){$("iframe")[0].contentWindow.Anzu.ui.moveBar(a)},changeTone:function(){var a=$('input[name="tone"]:checked').val();$("iframe")[0].contentWindow.Anzu.ui.changeTone(a);Anzu.eventManager.add("changeTone",a)},changeVolume:function(a){Anzu.player.score.getTrack(c).setVolume(a);
Anzu.eventManager.add("changeVolume",a)},selectTrack:function(a){c=parseInt(a.value)-1;this.set();$("#tracklist > li").each(function(i,l){l.className=""});a.className="current";Anzu.eventManager.changeCurrentTrack(c);return false},exportAsURL:function(a){Anzu.player.score.updateTrack(c,f());var i=Anzu.player.score.dump();return'http://anzutone.appspot.com/editor.html?load={"name":"'+encodeURI(a.name)+'","comment":"'+encodeURI(a.comment)+'","version":"'+a.version+'","score":'+i+"}"},openExportDialog:function(){var a=
this.exportAsURL({name:"Anzu",comment:"first",version:Anzu.core.version});$("#exportDialog").dialog("open");$("#exportDialogURL").html("I save your score <a href='"+encodeURI(a)+"'>this url</a>.<br><br>Bookmark it!")},load:function(a){try{var i=JSON.parse(a)}catch(l){alert("Parse Error. I cannot load this URL.")}e=i.name;d=i.comment;Anzu.eventManager.setDivID(i.score.maxID+1);Anzu.player.score=Anzu.Score(i.score);$("#bpmInput").val(Anzu.player.score.bpm);c=b=0;Anzu.player.set();$("#bpmForm").val(Anzu.player.score.bpm);
$("#bpmButton > .ui-button-text").html("BPM="+Anzu.player.score.bpm)},parseURL:function(){var a;if(document.location.href.match(/.+?load=(.+)/)){a=RegExp.$1;Anzu.player.load(decodeURI(a))}else this.set()},changeBPM:function(a){a=parseFloat(a);if(!(a<=0||a===NaN)){Anzu.player.score.changeBPM(a);Anzu.eventManager.add("changeBPM",a)}},_setBPM:function(a){Anzu.player.score.changeBPM(a);$("#bpmForm").val(a);$("#bpmButton > .ui-button-text").html("BPM="+a)},_setTone:function(a,i){Anzu.player.score.getTrack(a).setTone(i)},
_setVolume:function(a,i){Anzu.player.score.getTrack(a).setVolume(i)},frameLoaded:function(){setTimeout(function(){Anzu.player.setEventManager();Anzu.player.parseURL();Anzu.eventManager.init();Anzu.player.refreshTone()},500)},renderScoreAgain:function(){this.set()},refreshTone:function(){$("#toneSelect").html("");var a,i=Anzu.tone.getToneList();i.sort();var l,m=i.length;for(l=0;l<m;l++){a=i[l];var n;n=a.split(".")[0]==="Anzu"?a.split(".")[1]:a;$("#toneSelect").append($("<input>").attr("type","radio").attr("name",
"tone").attr("id","radio."+a).attr("value",a)).append($("<label>").attr("for","radio."+a).html(n))}$("#toneSelect").buttonset()},addUserTone:function(a,i){Anzu.tone.addUserTone(a,function(){i()},function(l){$("#userToneFormHelper").html("Error!!<br>"+l)})},setOnion:function(a){Anzu.player.score.getTrack(c).setOnion(a)}}}();Anzu.ui=function(){var j=["Ad","Ad#","Bd","Cd","Cd#","Dd","Dd#","Ed","Fd","Fd#","Gd","Gd#"],f={},b={},c,g,e,d;e=j.length;d=0;for(c=1;c<=9;c++)for(g=0;g<e;g++){f[1920-d+40]=j[g].replace("d",c.toString(10));b[j[g].replace("d",c.toString(10))]=1920-d+40;d+=20}return{killBuffer:[],divID:0,browser:IsGecko()?0:1,posKeyList:f,posKeyRev:b,defualtNoteLen:98}}();
Anzu.ui.initPianorole=function(j){function f(h){var k={};k.width=h.length*100;k.left=h.begin*100;k.top=w[h.key];return d(k,h)}function b(h,k){if(t!==k){k.anzuHelper={};k.anzuHelper.x=parseInt(t.style.left)-parseInt(k.style.left);k.anzuHelper.y=parseInt(t.style.top)-parseInt(k.style.top)}}function c(h,k){if(t!==k){k.style.left=parseInt(t.style.left)-k.anzuHelper.x+"px";k.style.top=parseInt(t.style.top)-k.anzuHelper.y+"px"}}function g(h,k){p.changeNote(k)}function e(h){var k=new Date,r=Math.floor(h.pageY/
20)*20;if(H!==r){h=v[Math.floor(h.pageY/20)*20];Anzu.ShortAudio(0.3,h);M=k;H=r}}function d(h,k){var r,s,D,E;if(k){s=k.divID;r=k;D=h.top;E=h.left}else{s=Anzu.eventManager.getDivID();Anzu.eventManager.incDivID();r=new Anzu.Note;p.addNote(r);D=Math.floor(h.top/20)*20+1;E=Math.floor(h.left/12.5)*12.5}h=$("<div>").addClass(q).attr("style","width: "+h.width+"px; height: 17px; margin 0px 20px 20px 0px;position: absolute; opacity: 0.9;top:"+D+"px;left:"+E+"px;").attr("id",s+"AnzutoneNoteDiv").resizable({maxHeight:17,
minHeight:17,stop:function(){Anzu.ui.defualtNoteLen=parseInt(this.style.width,10);p.changeNote(this)}}).draggable({grid:[12.5,20],start:function(x){var F=$("#role > .ui-selected");t=this;F.each(b);e(x)},drag:function(x){var F=$("#role > .ui-selected");t=this;F.each(c);e(x)},stop:function(){var x=$("#role > .ui-selected");t=this;x.each(c);x.each(g);p.changeNote(this)}});r.setDiv(h[0]);k||Anzu.eventManager.add("addNote",r);return h}function a(h){var k=$(h);p.deleteNoteFromDiv(h);k.draggable("destroy");
k.resizable("destroy");k.remove()}function i(h){Anzu.ui.killBuffer=[];var k=1E6;h.each(function(r,s){if(k>parseInt(s.style.left))k=parseInt(s.style.left)});h.each(function(r,s){$(s);Anzu.ui.killBuffer.push({top:parseInt(s.style.top),width:parseInt(s.style.width),left:parseInt(s.style.left)-k})})}function l(h){var k;k=h._notes();for(h=0;h<k.length;h++)m(k[h])}function m(h){var k={};k.width=h.length*100;k.left=h.begin*100;k.top=w[h.key];$("<div>").addClass(q).attr("style","width: "+k.width+"px; height: 17px; margin 0px 20px 20px 0px;position: absolute; opacity: 0.3;top:"+
k.top+"px;left:"+k.left+"px;").appendTo($("#role"))}function n(){var h=parseInt($("#bar")[0].style.left);h=(new Date-I)/1E3/J*(z-A);$("#bar")[0].style.left=h+A+"px";h>z+0.2&&o();document.body.scrollLeft=K+h}function o(){clearInterval(B);var h=parseInt($("#bar")[0].style.left);$("#bar")[0].style.left=Math.ceil(h/12.5)*12.5+"px";B=null}$("#role");var q="ui-widget-header",p=j;Anzu.ui.divID=Anzu.ui.divID?Anzu.ui.divID:0;Anzu.ui.track=p;var v=Anzu.ui.posKeyList,w=Anzu.ui.posKeyRev;$(window).unbind("dblclick");
$(window).unbind("keydown");$(document).selectable("destroy");$("#role > .ui-widget-header").each(function(h,k){var r=$(k);p.getNote(parseInt(r.id,10));r.animate({opacity:0.9},0,"linear",function(){r.draggable("destroy");r.resizable("destroy");r.remove()})});var u,t,M=new Date,H;u=p._notes().length;var C=p._notes();for(j=0;j<u;j++)f(C[j]).appendTo($("#role"));C=Anzu.ui.score.getOnionTracks();var G;u=C.length;for(j=0;j<u;j++){G=C[j];G!==p&&l(G)}$(window).dblclick(function(h){d({top:h.pageY,left:h.pageX,
width:Anzu.ui.defualtNoteLen}).appendTo($("#role"))});$(window).keydown(function(h){switch(h.keyCode){case 8:case 46:h=$("#role > .ui-selected");h.each(function(r,s){a(s)});break;case 67:if(!h.ctrlKey)return;h=$("#role > .ui-selected");if(h.length===0)return;i(h);break;case 86:case 89:h=parseInt($("#bar")[0].style.left);var k;for(k=0;k<Anzu.ui.killBuffer.length;k++){Anzu.ui.killBuffer[k].left+=h;d(Anzu.ui.killBuffer[k]).appendTo($("#role"))}break;case 87:case 88:h=$("#role > .ui-selected");h.each(function(r,
s){a(s)});if(h.length===0)return;i(h);break}});$(document).selectable({selected:function(h,k){h=k.selected;h.style.position&&h.id&&$(h).addClass("anzu-note-selected")},unselected:function(h,k){k.unselected.style.position&&$(k.unselected).removeClass("anzu-note-selected")},start:function(h){window.focus();e(h)},filter:"#role > [id]"});var y=$("#barTooltip")[0],L=$("#barTooltipInner")[0];$("#bar").draggable({axis:"x",grid:[12.5,1],start:function(h){y.style.top=h.pageY-20+"px";y.style.left=h.pageX+"px";
L.innerHTML="&nbsp;"+Math.floor(h.pageX/400)+" + "+h.pageX%400/100;y.style.display="block"},drag:function(h){var k=parseInt($("#bar")[0].style.left);y.style.top=h.pageY-20+"px";y.style.left=k+"px";L.innerHTML="&nbsp;"+Math.floor(k/400)+" + "+k%400/100},stop:function(){y.style.display="none"}});Anzu.ui.getTrack=function(){return p};var z,B,I,A,J,K;Anzu.ui.startAnimation=function(h,k,r){if(k<=0)return false;if(B)return false;z=k*100;A=parseInt($("#bar")[0].style.left)+r*100*Anzu.ui.browser;J=(z-A)/
100*h;I=new Date;K=document.body.scrollLeft;B=setInterval(n,50);return true};Anzu.ui.stopAnimation=o;Anzu.ui.moveBar=function(h){var k=parseInt($("#bar")[0].style.left);if(k+h<0)$("#bar")[0].style.left="0px";else{k=Math.ceil((k+h)/100)*100;$("#bar")[0].style.left=k+"px";document.body.scrollLeft=k-400}};Anzu.ui.changeTone=function(h){p.setTone(h);Anzu.tone.setDefaultTone(h)};Anzu.ui.changeVolume=function(h){p.setVolume(h);p.setTone(tone);Anzu.tone.setDefaultTone(tone)};Anzu.ui.changeTone(p.getTone());
window.focus()};Anzu.ui.getCurrentTime=function(){return parseInt($("#bar")[0].style.left)/100};Anzu.ui.setTrack=function(j){Anzu.ui.initPianorole(j)};Anzu.ui.setScore=function(j){Anzu.ui.score=j};

